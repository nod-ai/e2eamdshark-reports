on:
  workflow_dispatch:
  pull_request:
  schedule:
    - cron: "18 22 * * *"

permissions:
  contents: write

jobs:
  update-summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas plotly

      - name: Compute today's date
        id: today
        run: |
          echo "date=2025-12-29" >> $GITHUB_OUTPUT
          #echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Verify summary.md exists for llvm-cpu
        run: |
          SUMMARY_DIR="${{ steps.today.outputs.date }}/ci_reports_onnx/llvm-cpu/combined-reports_unique"
          if [ ! -f "$SUMMARY_DIR/summary.md" ]; then
            echo "summary.md not found at $SUMMARY_DIR"
            exit 1
          fi

      - name: Update passing summary CSV for llvm-cpu
        run: |
          SUMMARY_PATH="${{ steps.today.outputs.date }}/ci_reports_onnx/llvm-cpu/combined-reports_unique/summary.md"
          python github-actions/generate_csv.py \
            "$SUMMARY_PATH" \
            "track_test_data/llvm_cpu_passing_summary_daily.csv"

      - name: Generate passing summary graph for llvm-cpu
        run: |
          python github-actions/generate_graph.py \
            "track_test_data/llvm_cpu_passing_summary_daily.csv" \
            "track_test_data/llvm_cpu_passing_summary_last_30_days.html"

      - name: Verify summary.md exists for gpu
        run: |
          SUMMARY_DIR="${{ steps.today.outputs.date }}/ci_reports_onnx/rocm/combined-reports_unique"
          if [ ! -f "$SUMMARY_DIR/summary.md" ]; then
            echo "summary.md not found at $SUMMARY_DIR"
            exit 1
          fi

      - name: Update passing summary CSV for gpu
        run: |
          SUMMARY_PATH="${{ steps.today.outputs.date }}/ci_reports_onnx/rocm/combined-reports_unique/summary.md"
          python github-actions/generate_csv.py \
            "$SUMMARY_PATH" \
            "track_test_data/rocm_passing_summary_daily.csv"

      - name: Generate passing summary graph for gpu
        run: |
          python github-actions/generate_graph.py \
            "track_test_data/rocm_passing_summary_daily.csv" \
            "track_test_data/rocm_passing_summary_last_30_days.html"
      - name: Upload log files
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: onnx-model-success-track
          path: |
            track_test_data/

      - name: Commit and push updated CSV & HTML
        run: |
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"

          git checkout "$DEFAULT_BRANCH"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add track_test_data/

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update passing summary CSV and graph ($(date +%Y-%m-%d))"
            git push origin "$DEFAULT_BRANCH"
          fi

